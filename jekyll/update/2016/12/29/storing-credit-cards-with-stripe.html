<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="google-site-verification" content="TqEs8ICxE0CoIribqD9IJHftDs3_ruNUrhraleyGXlQ" />
  <!-- Begin Jekyll SEO tag v2.0.0 -->
<title>Storing Credit Cards with Stripe - The Giant Refactor</title>
<meta property="og:title" content="Storing Credit Cards with Stripe" />
<meta name="description" content="Stripe makes it very easy for developers to process payments in their Rails apps. However, models and controllers can easily become overwrought with logic when there’s no standard way to organize the different scenarios of charging  a customer. In this post, we’ll export the logic required to create and charge a Stripe Customer to a series of chained service objects." />
<meta property="og:description" content="Stripe makes it very easy for developers to process payments in their Rails apps. However, models and controllers can easily become overwrought with logic when there’s no standard way to organize the different scenarios of charging  a customer. In this post, we’ll export the logic required to create and charge a Stripe Customer to a series of chained service objects." />
<link rel="canonical" href="http://mfountoulakis.github.io/manos/jekyll/update/2016/12/29/storing-credit-cards-with-stripe.html" />
<meta property="og:url" content="http://mfountoulakis.github.io/manos/jekyll/update/2016/12/29/storing-credit-cards-with-stripe.html" />
<meta property="og:site_name" content="The Giant Refactor" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2016-12-29T23:01:00-05:00" />
<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Storing Credit Cards with Stripe",
    "datePublished": "2016-12-29T23:01:00-05:00",
    "description": "Stripe makes it very easy for developers to process payments in their Rails apps. However, models and controllers can easily become overwrought with logic when there’s no standard way to organize the different scenarios of charging  a customer. In this post, we’ll export the logic required to create and charge a Stripe Customer to a series of chained service objects.",
    "url": "http://mfountoulakis.github.io/manos/jekyll/update/2016/12/29/storing-credit-cards-with-stripe.html"
  }
</script>
<!-- End Jekyll SEO tag -->
  <title>Storing Credit Cards with Stripe</title>
  <link rel="stylesheet" href="/manos/vendor/css/materialize.min.css">
  <link rel="stylesheet" href="/manos/css/main.css">
  <link rel="stylesheet" href="/manos/css/syntax.css">
  <link rel="import" href="/manos/vendor/icons/social-media-icons.html">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/webcomponentsjs/0.7.7/webcomponents-lite.min.js"></script>
  <script src="/manos/vendor/js/jquery.min.js"></script>
  <script src="/manos/vendor/js/materialize.min.js"></script>
</head>
<body>
  <header>
    <!-- mobile menu -->
    <div class="mobile-menu hide-on-large-only container">
      <div class="nav-wrapper">
        <ul id="slide-out" class="side-nav">
          <li><div class="userView cyan">
            <div class="col s">
              <img src="images/manos.jpg" alt="" class="circle responsive-img"> <!-- notice the "circle" class -->
            </div>
            <span class="orange-text name">The Giant Refactor</span>
          </div></li>
          <li ><a href="/manos/">Home</a></li>
          <li ><a href="/manos/blog.html">Archive</a></li>
          <li ><a href="/manos/about.html">About</a></li>
        </ul>
        <ul>
          <li>
            <a href="#" data-activates="slide-out" class="button-collapse"><i class="material-icons">menu</i></a>
          </li>
        </ul>
        <!-- mobile menu -->
      </div>
    </div>
    <div class="navbar-fixed hide-on-med-and-down">
      <nav class="shadow white">
        <div class="nav-wrapper">
          <div class="content container">
            <ul class="right hide-on-med-and-down">
              <li><a href="https://github.com/mfountoulakis"><social-media-icons icon="github" color="#ffa726" size="25"></social-media-icons></a></li>
              <li><a href="https://www.linkedin.com/in/manos-fountoulakis-8bb38849?trk=nav_responsive_tab_profile_pic"><social-media-icons icon="linkedin" color="#ffa726" size="25"></social-media-icons></a></li>
              <li><a href="https://open.spotify.com/user/cheeseontoasty"><social-media-icons icon="spotify" color="#ffa726" size="25"></social-media-icons></a></li>
            </ul>
            <ul>
              <li ><a href="/manos/">Home</a></li>
              <li ><a href="/manos/blog.html">Archive</a></li>
              <li ><a href="/manos/about.html">About</a></li>
            </ul>
          </div>
        </div>
      </nav>
    </div>
  </header>
  <!-- <div class="content container"> -->
  <div class="flow-text">
    <main>
  <div class="content container page-margin">
    <main>
      <h2>Storing Credit Cards with Stripe</h2>


<span class="ttr">
  
  3 min read
  
</span>

<main>
  <p>Stripe makes it very easy for developers to process payments in their Rails apps. However, models and controllers can easily become overwrought with logic when there’s no standard way to organize the different scenarios of charging  a customer. In this post, we’ll export the logic required to create and charge a Stripe Customer to a series of chained service objects.
<!-- excerpt --></p>
<h4 id="setup">Setup</h4>
<p>Here’s some model setup steps, as well as the payment form for Stripe.</p>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="n">rails</span> <span class="n">g</span> <span class="n">model</span> <span class="n">payment</span> <span class="n">user</span><span class="ss">:references</span> <span class="n">stripe_token</span><span class="ss">:string</span> <span class="n">last4</span><span class="ss">:string</span> <span class="n">error</span><span class="ss">:string</span>
<span class="n">rails</span> <span class="n">g</span> <span class="n">model</span> <span class="n">user</span> <span class="n">stripe_customer_id</span><span class="ss">:string</span>
<span class="n">rails</span> <span class="n">g</span> <span class="n">model</span> <span class="n">card</span> <span class="n">user</span><span class="ss">:references</span> <span class="n">stripe_token</span><span class="ss">:string</span> <span class="n">last4</span><span class="ss">:string</span>
</code></pre>
</div>
<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/142b09b34da642681db68f03bb60f3a5.js"> </script>

<p>Stripe supplies us with the code to retrieve a token from the Stripe   API once our form is submitted. You can read more about it in the Stripe docs. <a href="https://stripe.com/docs/custom-form">https://stripe.com/docs/custom-form</a>.
<br />
<br /></p>
<h4 id="step-1-instantiate-the-new-service">Step 1: Instantiate the new service</h4>
<hr />
<p>The payment controller will handle the token sent from our payment form. After the payment is saved we’ll Instantiate our new service.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">create</span>
  <span class="vi">@payment</span> <span class="o">=</span> <span class="no">Payment</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="n">payment_params</span><span class="p">)</span>
  <span class="k">if</span> <span class="vi">@payment</span><span class="p">.</span><span class="nf">save</span>    
    <span class="no">CreateStripeCustomerService</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@payment</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre>
</div>
<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/ef042c009f3d53675979a31e194a8739.js"> </script>

<p><br /></p>
<h4 id="step-2-create-a-new-stripe-customer">Step 2: Create a new Stripe customer</h4>
<hr />
<p>When the <strong><code class="highlighter-rouge">CreateStripeCustomer</code></strong> service is instantiated, it is passed the payment instance as an argument. Since we’re not calling a specific method, we’ll call the method <strong><code class="highlighter-rouge">create_customer</code></strong> in the <strong><code class="highlighter-rouge">CreateStripeCustomer</code></strong> service initialize method.</p>

<p>The CreateCustomer service has two responsibilities:</p>
<ol>
  <li>Create a new customer if the user’s <strong><code class="highlighter-rouge">stripe_customer_id</code></strong> is blank.</li>
  <li>send the payment to the <strong><code class="highlighter-rouge">ChargeCreditCard</code></strong> service.</li>
</ol>

<p>Once the customer is created and <strong><code class="highlighter-rouge">stripe_customer_id</code></strong> is assigned to the user, the new service is instantiated, passing the payment as an argument, and calling the method <strong><code class="highlighter-rouge">charge_or_create_card</code></strong>.</p>
<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="no">ChargeCreditCard</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">payment</span> <span class="o">=</span> <span class="vi">@payment</span><span class="p">).</span><span class="nf">charge_or_create_card</span>
</code></pre>
</div>
<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/5345fa9f722459db6814e32c2fd57009.js"> </script>

<p><br /></p>
<h4 id="step-3-charging-the-credit-card">Step 3: Charging the credit card.</h4>
<hr />
<p>Finally, we can charge the user’s credit card. On line 12, we’ll find out if the Stripe token has been used. If not, it will be added to the customer’s payment sources. Since Stripe tokens can only be used once, we’ll be charging the card associated with the Stripe token (the source object), instead of the card token itself. The initialize method of our <strong><code class="highlighter-rouge">ChargeCreditCard</code></strong> service retrieves the card id from the Stripe API and stores it in a variable.</p>

<div class="language-ruby highlighter-rouge"><pre class="highlight"><code><span class="vi">@card</span> <span class="o">=</span> <span class="no">Stripe</span><span class="o">::</span><span class="no">Token</span><span class="p">.</span><span class="nf">retrieve</span><span class="p">(</span><span class="vi">@payment</span><span class="p">.</span><span class="nf">stripe_token</span><span class="p">).</span><span class="nf">card</span><span class="p">.</span><span class="nf">id</span>
</code></pre>
</div>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/9129aef9d2ccfd646ce4a876fe9bac59.js"> </script>

<p><br /></p>
<h4 id="step-4-create-a-card-record">Step 4: Create a card record</h4>
<hr />
<p>Our final service finds or creates a card record based on the payment’s stripe token. This will allow us to display the card to the user in the payments form. We’ll store the stripe token once again in the card record. Alternatively, you could save the card id directly instead of retrieving it from the token.</p>

<noscript><pre>400: Invalid request
</pre></noscript>
<script src="https://gist.github.com/c4886502a9e6c90285b5bd46ce1459fb.js"> </script>

<p><br /></p>
<h4 id="step-5-display-the-cards-to-the-user">Step 5: Display the cards to the user.</h4>
<hr />
<p>Display the user’s cards in the payments form with radio buttons.</p>
<div class="language-erb highlighter-rouge"><pre class="highlight"><code><span class="c">&lt;!-- #app/views/payments/_form.html.erb --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-row"</span><span class="nt">&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">if</span> <span class="vi">@cards</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="vi">@cards</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">card</span><span class="o">|</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">radio_button</span><span class="p">(</span><span class="s2">"payment"</span><span class="p">,</span> <span class="s2">"stripe_token"</span><span class="p">,</span> <span class="n">card</span><span class="p">.</span><span class="nf">stripe_token</span><span class="p">)</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">label_tag</span><span class="p">(</span><span class="ss">:card</span><span class="p">,</span> <span class="n">card</span><span class="p">.</span><span class="nf">last4</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre>
</div>

</main>

<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//manos-2.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

    </main>
  </div>
</main>

  </main>
  <!-- </div> -->
  <footer class="page-footer orange lighten-1">
    <div class="container">
      <div class="row">
        <div class="col l6 s12">
          <h5 class="white-text">Sitemap</h5>
          <p class="grey-text text-lighten-4">mmmmmmm nothing here yet. Check back later.</p>
        </div>
        <div class="col l4 offset-l2 s12">
          <!-- <h5 class="white-text">Links</h5> -->
          <ul>
            <!-- <li><a class="grey-text text-lighten-3" href="#!">Link 2</a></li>
            <li><a class="grey-text text-lighten-3" href="#!">Link 3</a></li>
            <li><a class="grey-text text-lighten-3" href="#!">Link 4</a></li> -->
          </ul>
        </div>
      </div>
    </div>
    <div class="footer-copyright">
      <div class="container">
        All content copyright Manos Fountoulakis © 2016 Copyright Text
      </div>
    </div>
  </footer>
</body>
<script>
$(document).ready(function(){
  $(".button-collapse").sideNav();
  $('.collapsible').collapsible();
});
</script>
</html>
